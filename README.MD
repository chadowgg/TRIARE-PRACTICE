# üÉè Durak Online Development Plan

**Tech Stack:**
- **Frontend:** React (Vite), TypeScript, TailwindCSS, shadcn/ui.
- **Backend:** NestJS, TypeScript, Socket.io (Websockets).
- **Database:** MongoDB (Mongoose/Prisma).
- **State Management:** Zustand (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ) –∞–±–æ Redux Toolkit.
- **Shared:** Monorepo (Nx –∞–±–æ Turborepo) –∞–±–æ Shared Types folder.

---

## üèõ –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ **–ì—ñ–±—Ä–∏–¥–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥**:
1.  **HTTP (REST API):** –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, –ø—Ä–æ—Ñ—ñ–ª—ñ–≤, —ñ—Å—Ç–æ—Ä—ñ—ó —ñ–≥–æ—Ä, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.
2.  **WebSocket (Socket.io):** –í–∏–∫–ª—é—á–Ω–æ –¥–ª—è —ñ–≥—Ä–æ–≤–∏—Ö –∫—ñ–º–Ω–∞—Ç (Lobbies), —á–∞—Ç—É —Ç–∞ –ø—Ä–æ—Ü–µ—Å—É –≥—Ä–∏.

---

## üìÖ –ï—Ç–∞–ø 1: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —Ç–∞ –°–ø—ñ–ª—å–Ω—ñ –¢–∏–ø–∏

–ü–µ—Ä—à –Ω—ñ–∂ –ø–∏—Å–∞—Ç–∏ –ª–æ–≥—ñ–∫—É, —Ç—Ä–µ–±–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –æ–±–º—ñ–Ω —Ç–∏–ø–∞–º–∏ –º—ñ–∂ —Ñ—Ä–æ–Ω—Ç–æ–º —ñ –±–µ–∫–æ–º.

- [ ] **–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Monorepo** (–∞–±–æ –ø—Ä–æ—Å—Ç–æ –ø–∞–ø–∫–∏ `/shared` —è–∫—â–æ —Ü–µ –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π).
- [ ] **–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤ (DTOs):**
    ```typescript
    // shared/types.ts
    export type Suit = 'hearts' | 'diamonds' | 'clubs' | 'spades';
    export type Rank = '6' | '7' | '8' | '9' | '10' | 'J' | 'Q' | 'K' | 'A';

    export interface ICard {
      suit: Suit;
      rank: Rank;
    }

    export interface IPlayer {
      id: string;
      username: string;
      avatarUrl?: string;
      cardsCount: number; // –Ü–Ω—à—ñ –Ω–µ –º–∞—é—Ç—å –∑–Ω–∞—Ç–∏, —è–∫—ñ —Å–∞–º–µ –∫–∞—Ä—Ç–∏, —Ç—ñ–ª—å–∫–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
      isReady: boolean;
    }

    export interface IGameState {
      lobbyId: string;
      status: 'waiting' | 'playing' | 'finished';
      trumpCard: ICard;
      deckCount: number;
      tableCards: { attack: ICard; defend?: ICard }[];
      currentPlayerId: string; // –ß–∏–π —Ö—ñ–¥
      players: IPlayer[];
    }
    ```

---

## üîê –ï—Ç–∞–ø 2: Backend - –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —Ç–∞ Auth (HTTP)

–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è REST API –¥–ª—è –≤—Ö–æ–¥—É –≤ —Å–∏—Å—Ç–µ–º—É.

- [ ] **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è MongoDB:**
    - –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è `MongooseModule` –≤ NestJS.
- [ ] **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ö–µ–º (Schemas):**
    - `UserSchema`: `email`, `password` (hash), `nickname`, `stats` (wins, loses, elo).
    - `MatchSchema`: `startTime`, `endTime`, `winnerId`, `participants`.
- [ ] **–ú–æ–¥—É–ª—å Auth:**
    - [ ] –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (`POST /auth/register`).
    - [ ] –õ–æ–≥—ñ–Ω (`POST /auth/login`) -> –≤–∏–¥–∞—á–∞ JWT.
    - [ ] Guard –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É —Ä–æ—É—Ç—ñ–≤ (`JwtAuthGuard`).
- [ ] **–ú–æ–¥—É–ª—å Users:**
    - [ ] –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é (`GET /users/me`).
    - [ ] –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (`GET /users/:id/stats`).

---

## üéÆ –ï—Ç–∞–ø 3: Backend - Game Core (–ß–∏—Å—Ç–∞ –ª–æ–≥—ñ–∫–∞)

–ü–∏—à–µ–º–æ –¥–≤–∏–≥—É–Ω –≥—Ä–∏ –±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ —Å–æ–∫–µ—Ç—ñ–≤. –¶–µ –ø—Ä–æ—Å—Ç–æ –∫–ª–∞—Å–∏ TS.

- [ ] **–ö–ª–∞—Å `Deck`:** –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è 36/52 –∫–∞—Ä—Ç, –ø–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è (`shuffle`), —Ä–æ–∑–¥–∞—á–∞.
- [ ] **–ö–ª–∞—Å `DurakGame`:**
    - –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –ø–∞—Ä—Ç—ñ—ó.
    - –ú–µ—Ç–æ–¥ `joinPlayer(user)` / `leavePlayer(userId)`.
    - –ú–µ—Ç–æ–¥ `attack(userId, card)`: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ (—á–∏ —î –∫–∞—Ä—Ç–∞, —á–∏ –º–æ–∂–Ω–∞ –ø—ñ–¥–∫–∏–¥–∞—Ç–∏).
    - –ú–µ—Ç–æ–¥ `defend(userId, attackCard, defendCard)`: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –±'—î –∫–∞—Ä—Ç–∞.
    - –ú–µ—Ç–æ–¥ `take(userId)`: –ì—Ä–∞–≤–µ—Ü—å –∑–∞–±–∏—Ä–∞—î –∫–∞—Ä—Ç–∏ –∑—ñ —Å—Ç–æ–ª—É.
    - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–º–æ–≤ –ø–µ—Ä–µ–º–æ–≥–∏/–ø—Ä–æ–≥—Ä–∞—à—É.

---

## üîå –ï—Ç–∞–ø 4: Backend - WebSockets & Lobby Manager

–ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ª–æ–≥—ñ–∫—É –¥–æ –º–µ—Ä–µ–∂—ñ —á–µ—Ä–µ–∑ NestJS Gateways.

- [ ] **Lobby Manager (Service):**
    - –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö —ñ–≥–æ—Ä —É –ø–∞–º'—è—Ç—ñ (Map `lobbyId` -> `DurakGame instance`).
    - –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è **Invite Codes** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `AG45B` -> –º–∞–ø–∏—Ç—å—Å—è –Ω–∞ `UUID` –∫—ñ–º–Ω–∞—Ç–∏).
- [ ] **Game Gateway (`@WebSocketGateway`):**
    - `handleConnection`: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞ –∑ handshake.
    - Event `create_lobby`: –°—Ç–≤–æ—Ä—é—î –≥—Ä—É, –ø–æ–≤–µ—Ä—Ç–∞—î `lobbyId` —Ç–∞ `inviteCode`.
    - Event `join_lobby`: –ü—Ä–∏–π–º–∞—î –∫–æ–¥, –¥–æ–¥–∞—î —Å–æ–∫–µ—Ç —É –∫—ñ–º–Ω–∞—Ç—É `socket.join(lobbyId)`.
    - Event `player_action`: –û—Ç—Ä–∏–º—É—î —Ö—ñ–¥, –≤–∏–∫–ª–∏–∫–∞—î –º–µ—Ç–æ–¥ `DurakGame`, –µ–º—ñ—Ç–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–µ–π—Ç.
- [ ] **–û–±—Ä–æ–±–∫–∞ —Ä–æ–∑—Ä–∏–≤—É –∑'—î–¥–Ω–∞–Ω–Ω—è:**
    - –¢–∞–π–º–µ—Ä –Ω–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 30 —Å–µ–∫), —ñ–Ω–∞–∫—à–µ —Ç–µ—Ö. –ø–æ—Ä–∞–∑–∫–∞.

---

## üñ• –ï—Ç–∞–ø 5: Frontend - UI & Integration

React –¥–æ–¥–∞—Ç–æ–∫ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º shadcn/ui.

- [ ] **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Routing:**
    - `/login`, `/register`
    - `/` (Dashboard: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∫–Ω–æ–ø–∫–∞ "–°—Ç–≤–æ—Ä–∏—Ç–∏", –∫–Ω–æ–ø–∫–∞ "–£–≤—ñ–π—Ç–∏ –∑–∞ –∫–æ–¥–æ–º").
    - `/game/:id` (–°–∞–º–µ —ñ–≥—Ä–æ–≤–µ –ø–æ–ª–µ).
- [ ] **UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ (Shadcn):**
    - –§–æ—Ä–º–∏ –≤—Ö–æ–¥—É/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.
    - –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ü–Ω–≤–∞–π—Ç-–∫–æ–¥—É.
    - **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –≥—Ä–∏:**
        - `PlayingCard`: –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (–º–æ–∂–Ω–∞ –≤–∑—è—Ç–∏ –≥–æ—Ç–æ–≤—ñ SVG –∞—Å–µ—Ç–∏).
        - `GameBoard`: —Å—Ç—ñ–ª, –¥–µ –ª–µ–∂–∞—Ç—å –∫–∞—Ä—Ç–∏.
        - `PlayerAvatar`: –∑ —Ç–∞–π–º–µ—Ä–æ–º —Ö–æ–¥—É.
- [ ] **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è WebSocket:**
    - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ö—É–∫–∞ `useGameSocket`.
    - –°–ª—É—Ö–∞–Ω–Ω—è –ø–æ–¥—ñ–π: `game_started`, `update_state`, `player_error`.
    - –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É: "–Ø–∫—â–æ `myTurn === true`, –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –º–æ—ó –∫–∞—Ä—Ç–∏".

---

## üöÄ –ï—Ç–∞–ø 6: –ü–æ–ª—ñ—à–∏–Ω–≥ —Ç–∞ –§—ñ—á—ñ

- [ ] **–í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–∞–≤–∏–ª:** –ü—ñ–¥–∫–∏–¥–Ω–∏–π, –ü–µ—Ä–µ–≤—ñ–¥–Ω–∏–π (–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ª–æ–±–±—ñ).
- [ ] **–ê–Ω—ñ–º–∞—Ü—ñ—ó:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `Framer Motion` –¥–ª—è —Ä—É—Ö—É –∫–∞—Ä—Ç (—Ä–æ–∑–¥–∞—á–∞, —Ö—ñ–¥, –±–∏—Ç–æ).
- [ ] **–¢–∞–π–º–µ—Ä–∏ —Ö–æ–¥—É:** –ù–∞ –±–µ–∫–µ–Ω–¥—ñ (—â–æ–± –Ω–µ —á–∏—Ç–µ—Ä–∏–ª–∏) + –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç—ñ.
- [ ] **–ß–∞—Ç —É –ª–æ–±–±—ñ:** –ü—Ä–æ—Å—Ç–∏–π —Ç–µ–∫—Å—Ç–æ–≤–∏–π —á–∞—Ç.

---

## ‚ö†Ô∏è –†–∏–∑–∏–∫–∏ —Ç–∞ –Ω—é–∞–Ω—Å–∏ (Note)

1.  **Race Conditions:** –Ø–∫—â–æ –¥–≤–∞ –≥—Ä–∞–≤—Ü—ñ —Ö–æ–¥—è—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–æ.
    * *–†—ñ—à–µ–Ω–Ω—è:* –ß–µ—Ä–≥–∞ –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ–π –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ –∞–±–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Å—Ç–æ–ª—É –Ω–∞ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó (—Ö–æ—á–∞ –± –ª–æ–≥—ñ—á–Ω–µ).
2.  **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è:**
    * –ó–∞–≤–∂–¥–∏ –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ **–ø–æ–≤–Ω–∏–π —Å—Ç–∞–Ω —Å—Ç–æ–ª—É** –ø—ñ—Å–ª—è —Ö–æ–¥—É, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "–≥—Ä–∞–≤–µ—Ü—å –ø–æ—Ö–æ–¥–∏–≤ –∫–∞—Ä—Ç–æ—é –•". –¶–µ —É–Ω–∏–∫–Ω–µ —Ä–æ–∑—Å–∏–Ω—Ö—Ä–æ–Ω—É.
3.  **–ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è:**
    * –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É —ñ–≥–æ—Ä —É –ø–∞–º'—è—Ç—ñ —Å–µ—Ä–≤–µ—Ä–∞ (RAM) –Ω–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫—ñ–ª—å–∫–∞ —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤ –±–µ–∫–µ–Ω–¥—É. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω—É –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è **Redis Adapter** –¥–ª—è Socket.io.